jobs:
  build:
    name: Build (${{ matrix.target }})
    runs-on: ${{ matrix.runner }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - target: linux-amd64
            runner: ubuntu-latest
          - target: windows-amd64
            runner: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------------- LINUX (manylinux_2_28) ----------------
      - name: Build Linux binary in manylinux_2_28
        if: matrix.target == 'linux-amd64'
        shell: bash
        run: |
          set -euxo pipefail

          VERSION="${{ inputs.version }}"
          ASSET="dsutil-${VERSION}-linux-amd64"

          # Важно: сборка внутри manylinux_2_28 (glibc 2.28)
          docker run --rm \
            -v "${PWD}:/io" \
            -w /io \
            quay.io/pypa/manylinux_2_28_x86_64 \
            bash -lc '
              set -euxo pipefail
              /opt/python/cp312-cp312/bin/python -m pip install --upgrade pip
              /opt/python/cp312-cp312/bin/python -m pip install pyinstaller
              /opt/python/cp312-cp312/bin/pyinstaller -F -n dsutil --paths src --collect-submodules dsutil entrypoint.py
            '

          mkdir -p out
          cp -f dist/dsutil "out/${ASSET}"

      - name: Upload Linux artifact
        if: matrix.target == 'linux-amd64'
        uses: actions/upload-artifact@v4
        with:
          name: dsutil-${{ inputs.version }}-linux-amd64
          path: out/dsutil-${{ inputs.version }}-linux-amd64
          if-no-files-found: error

      # ---------------- WINDOWS ----------------
      - name: Setup Python (Windows)
        if: matrix.target == 'windows-amd64'
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install build dependencies (Windows)
        if: matrix.target == 'windows-amd64'
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyinstaller

      - name: Build binary with PyInstaller (Windows)
        if: matrix.target == 'windows-amd64'
        shell: bash
        run: |
          pyinstaller -F -n dsutil --paths src --collect-submodules dsutil entrypoint.py

      - name: Prepare Windows asset
        if: matrix.target == 'windows-amd64'
        shell: bash
        run: |
          VERSION="${{ inputs.version }}"
          mkdir -p out
          cp -f dist/dsutil.exe "out/dsutil-${VERSION}-windows-amd64.exe"

      - name: Upload Windows artifact
        if: matrix.target == 'windows-amd64'
        uses: actions/upload-artifact@v4
        with:
          name: dsutil-${{ inputs.version }}-windows-amd64.exe
          path: out/dsutil-${{ inputs.version }}-windows-amd64.exe
          if-no-files-found: error
